<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${user.name}">User Profile</title>

    <link rel="stylesheet" href="/main.css" />
    <link rel="stylesheet" href="/two-column-pages.css" />
    <link rel="stylesheet" href="/navbar.css"/>
    <link rel="stylesheet" href="/user-profile.css"/>
    <link rel="stylesheet" href="/theme.css"/>
    <link rel="stylesheet" href="/index.css"/>
    <th:block th:replace="~{fragments/timezone-script :: timezone-detector}"></th:block>
</head>
<header class="page-header">
    <div th:insert="~{fragments/navbar :: headerNav}"></div>
</header>
<body>

<!-- header box -->
<div class="header-layout">
<div th:if="${!editing}" class="box user-header">
        <!-- profile picture -->
        <div class="header-box profile-picture">
            <img th:src="${user.avatar} ?: '/uploads/default_profile.png'"
                 alt="Profile picture"
                 style="width:160px;height:160px;object-fit:cover;"/>
        </div>
        <!-- account type, name, username, bio and location -->
        <div class="header-box">
            <!-- Account type-->
            <h4>Fan account</h4>
            <!-- Name -->
            <h1 th:text="${user.name}"></h1>
            <!-- Username -->
            <p th:text="'@' + ${user.username}"></p>
            <!-- Bio -->
            <p th:text="${user.bio}"></p>
            <!-- Location -->
            <div th:if="${user.location != null}">
                <p th:text="'ðŸ“ ' + ${user.location}"></p>
            </div>
        </div>
    <div>
        <a th:href="@{/users/{id}/edit(id=${user.id})}">
            <button>Edit Profile</button>
        </a>
    </div>
</div>

<!-- header box when in EDITING MODE-->
<div th:if="${editing}" class="box form-container">
    <h2>Edit Profile Information</h2>
    <form th:action="@{/users/{id}(id=${user.id})}"
            method="post"
            enctype="multipart/form-data"
            class="user-header edit-mode">
        <!-- profile picture -->
        <div class="header-box">
            <div>
                <label>Change profile image</label>
                <input type="file" name="image" accept="image/*"/>
            </div>
            <!-- Name -->
            <div>
                <label for="edit-name">Name</label>
                <input type="text"
                       name="name"
                       id="edit-name"
                       th:value="${user.name}"/>
            </div>
            <!-- Username -->
            <div>
                <label for="edit-username">Username</label>
                <input type="text"
                       name="username"
                       id="edit-username"
                       th:value="${user.username}"/>
            </div>
        </div>
        <!-- Bio, location -->
        <div class="header-box">
            <!-- Bio -->
            <div>
                <label for="edit-bio">Bio</label>
                <textarea name="bio"
                          rows="4"
                          id="edit-bio"
                          th:text="${user.bio}"></textarea>
            </div>
            <!-- Location -->
            <div>
                <label for="edit-location">Change location</label>
                <input type="text" name="location" id="edit-location" th:value="${user.location}"/>
            </div>
        </div>
        <!-- Action buttons -->
        <div>
                <button type="submit">Save Changes</button>
                <button th:href="@{/users/{id}(id=${user.id})}" class="btn">
                    Cancel
                </button>
        </div>
    </form>
</div>
</div>

<div class="page-layout">
    <!-- left column -->
    <aside class="left-column">

        <!-- Spotify box -->
        <div th:if="${isOwner}">
            <div th:if="${user.spotifyRefreshToken == null}">
                <a th:href="@{/spotify/connect}" class="btn btn-success">Connect Spotify</a>
            </div>
            <div th:unless="${user.spotifyRefreshToken == null}">
                <form th:action="@{/spotify/disconnect}" method="post">
                    <button class="btn btn-outline-danger" type="submit">Disconnect Spotify</button>
                </form>
                <p></p>
            </div>
        </div>
        <div th:if="${isOwner or (!isOwner and canShowPublicTopArtists)}">
            <div class="box">
                <h3 th:text="${isOwner} ? 'Your Top Artists' : 'Top Artists'">Top Artists</h3>

                <div th:if="${isOwner and user.spotifyRefreshToken != null}">
                    <form method="post" action="/user/spotify/privacy">
                        <label>
                            <input type="checkbox" name="shareTopArtists" th:checked="${user.shareSpotifyTopArtists}">
                            Show my Top Artists on my public profile
                        </label>
                        <button type="submit" class="btn btn-sm btn-outline-secondary">Save</button>
                    </form>
                </div>

                <div th:if="${user.spotifyRefreshToken == null}">
                    <p>Connect Spotify to show your top artists.</p>
                </div>

                <div th:if="${user.spotifyRefreshToken != null and (spotifyTopArtists == null or #lists.isEmpty(spotifyTopArtists))}">
                    <p>No top artists returned yet. Try listening on Spotify and check again later.</p>
                </div>

                <div th:if="${user.spotifyRefreshToken != null}">
                    <form method="get"
                          th:action="${isOwner} ? @{/user} : @{/users/{id}(id=${user.id})}" style="margin-bottom: 10px;">
                        <label for="timeRange" style="display:block; margin-bottom:4px;">
                            Time range
                        </label>
                        <select id="timeRange" name="timeRange" onchange="this.form.submit()">
                            <option value="short_term"
                                    th:selected="${timeRange == 'short_term'}">
                                Last 4 weeks
                            </option>
                            <option value="medium_term"
                                    th:selected="${timeRange == 'medium_term'}">
                                Last 6 months
                            </option>
                            <option value="long_term"
                                    th:selected="${timeRange == 'long_term'}">
                                All time-ish
                            </option>
                        </select>
                    </form>
                </div>

                <ul th:if="${spotifyTopArtists != null and !#lists.isEmpty(spotifyTopArtists)}">
                    <li th:each="a : ${spotifyTopArtists}">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <img th:if="${a.images != null and !#lists.isEmpty(a.images)}"
                                 th:src="${a.images.get(0).url}"
                                 style="width:40px; height:40px; border-radius:8px; object-fit:cover;" />

                            <div style="display:flex; flex-direction:column;">
                                <span th:text="${a.name}">Artist Name</span>

                                <a th:if="${spotifySuggestions != null and spotifySuggestions.containsKey(a.id)}"
                                   th:href="@{/artists/{id}(id=${spotifySuggestions.get(a.id).id})}">
                                    View on Mosh Pit
                                </a>

                                <span th:unless="${spotifySuggestions != null and spotifySuggestions.containsKey(a.id)}"
                                      style="opacity:0.7; font-size:0.9em;">
                            Not on Mosh Pit yet
                        </span>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <div th:if="${isOwner}">
            <div class="box">
                <h3>Currently Listening</h3>
                <div id="now-playing" class="card shadow-sm mb-4" style="display:none;">
                    <div class="card-body d-flex align-items-center gap-3">
                        <img id="np-art" alt="Album art"
                             style="width:64px;height:64px;object-fit:cover;border-radius:8px;display:none;">
                        <div style="flex:1;">
                            <div class="text-muted" style="font-size:0.9rem;">Currently listening</div>
                            <div id="np-title" style="font-weight:600;"></div>
                            <div id="np-artist" class="text-muted"></div>
                            <div id="np-status" class="text-muted" style="font-size:0.9rem;"></div>
                        </div>
                        <a id="np-link" target="_blank" class="btn btn-sm btn-outline-secondary" style="display:none;">Open</a>
                    </div>
                </div>
                <script>
                    async function refreshNowPlaying() {
                      try {
                        const res = await fetch('/api/spotify/now-playing', { headers: { 'Accept': 'application/json' }});
                        const data = await res.json();

                        const card = document.getElementById('now-playing');
                        const art = document.getElementById('np-art');
                        const title = document.getElementById('np-title');
                        const artist = document.getElementById('np-artist');
                        const status = document.getElementById('np-status');
                        const link = document.getElementById('np-link');

                        if (!data.connected) {
                          card.style.display = 'none';
                          return;
                        }

                        card.style.display = 'block';

                        if (!data.isPlaying) {
                          art.style.display = 'none';
                          link.style.display = 'none';
                          title.textContent = data.message || 'Nothing currently playing';
                          artist.textContent = '';
                          status.textContent = '';
                          return;
                        }

                        title.textContent = data.trackName || '';
                        artist.textContent = data.artists || '';
                        status.textContent = data.albumName ? `on ${data.albumName}` : '';

                        if (data.albumImageUrl) {
                          art.src = data.albumImageUrl;
                          art.style.display = 'block';
                        } else {
                          art.style.display = 'none';
                        }

                        if (data.spotifyUrl) {
                          link.href = data.spotifyUrl;
                          link.style.display = 'inline-block';
                        } else {
                          link.style.display = 'none';
                        }
                      } catch (e) {
                        console.warn('Now playing refresh failed', e);
                      }
                    }

                    refreshNowPlaying();
                    setInterval(refreshNowPlaying, 5000);
                </script>
            </div>
        </div>

    </aside>

    <main class="right-column" id="fan-feed">

        <input type="radio" name="profile-tabs" id="tab-followed" checked>
        <input type="radio" name="profile-tabs" id="tab-shows">
        <input type="radio" name="profile-tabs" id="tab-posts">
        <input type="radio" name="profile-tabs" id="tab-myartists">

        <nav class="nav-bar">
            <label for="tab-followed">Followed Artists</label>
            <label for="tab-shows">My Shows</label>
            <label for="tab-posts">Posts</label>
        </nav>

        <section class="tab-content" id="content-followed">
            <div class="box">
                <ul style="display: flex;" th:class="artist-list" th:if="${not #lists.isEmpty(followedArtists)}">
                    <li th:each="artist : ${followedArtists}">
                        <div th:replace="~{fragments/display-card :: displayCard(
                            ${artist.name},
                            '/artists/' + ${artist.id},
                            ${artist.avatar != null ? artist.avatar : 'https://placehold.co/128'},
                            'Picture of ' + ${artist.name}
                            )}">
                        </div>
                    </li>
                </ul>

                <p th:if="${#lists.isEmpty(followedArtists)}">No followed artists yet!</p>
            </div>
        </section>

        <section class="tab-content" id="content-shows">
            <div class="box">
                <div th:class="concerts-column">
                    <div class="feed-post box" th:each="concert:${concerts}">
                        <div>
                            <a th:href="@{/artists/{id}(id=${concert.artist.id})}">
                                <h2 th:text="${concert.artist.name}"></h2>
                            </a>
                            <h3 th:text="${concert.venue.venueName}"></h3>
                            <p th:text="${#temporals.format(concert.concertDate, 'dd MMM yyyy')} + ' - ' + ${concert.venue.city} + ', ' + ${concert.venue.country}"></p>
                        </div>
                    </div>
                </div>

                <p th:if="${#lists.isEmpty(concerts)}">No shows yet!</p>
            </div>
        </section>

        <!--- Post formatted section -->

        <section class="tab-content" id="content-posts">
            <section id="user-posts" class="box user-posts">
                <h2>Posts</h2>

                <!-- Empty state -->
                <div class="feed-post box" th:if="${posts == null or #lists.isEmpty(posts)}">
                    <p>No posts yet.</p>
                </div>

                <!-- Posts -->
                <div class="feed-post box" th:if="${posts != null and !#lists.isEmpty(posts)}"
                     th:each="post : ${posts}">
                    <div class="post-header">
                        <h3 th:text="${user.username}">SUNNY</h3>
                        <span class="post-time"
                              th:text="${#temporals.format(post.timestamp,'yyyy-MM-dd HH:mm:ss', userTimezone)}"></span>
                    </div>

                    <!-- NOT a link -->
                    <p class="post-body" style="white-space: pre-wrap;" th:text="${post.content}"></p>

                    <!-- ONLY this line is clickable -->
                    <a class="post-source"
                       th:if="${post.concert != null}"
                       th:href="@{/concerts/{id}(id=${post.concert.id})}">
                        <span th:text="${post.concert.artist.name}">Artist</span>
                        <span aria-hidden="true"> â€¢ </span>
                        <span th:text="${post.concert.venue.venueName}">Venue</span>
                    </a>
                </div>

            </section>
        </section>


        <div th:replace="~{fragments/action-dialogue :: dialog(
        title='My Artists',
        id='myArtists',
        cta_link='/artists/new',
        cta='Add new artist',
        content=(~{::artistList})
        )}">
            <div th:fragment="artistList">
                <ul style="display: flex; margin: 12px 0;">
                    <li th:each="artist : ${myArtists}">
                        <div
                                th:replace="~{fragments/display-card :: displayCard(${artist.name}, 'artists/' + ${artist.id}, 'https://placehold.co/128', 'Picture of artist')}">
                        </div>
                        <form th:action="@{/artists/{artistId}/switch-to-admin(artistId=${artist.id})}" method="post">
                            <button type="submit" style="margin-top: 5px;">
                                Switch to admin mode
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>

    </main>

</div>

</body>
</html>
