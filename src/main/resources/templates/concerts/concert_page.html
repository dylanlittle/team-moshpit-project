<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Concert</title>

    <link rel="stylesheet" href="/main.css" />
    <link rel="stylesheet" href="/concerts.css" />
    <link rel="stylesheet" href="/navbar.css"/>
    <link rel="stylesheet" href="/theme.css"/>
    <link rel="stylesheet" href="/user-profile.css"/>

    <th:block th:replace="~{fragments/timezone-script :: timezone-detector}"></th:block>
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <script src="/js/rsvp.js" defer></script>
    <script src="/js/posts.js" defer></script>
    <script src="/js/concertGallery.js" defer></script>
</head>
<header class="page-header">
    <div th:insert="~{fragments/navbar :: headerNav}"></div>
</header>
<body>

<!-- Header -->
<div class="header-layout">
    <div class="box user-header">
        <div class="header-box profile-picture">
            <img th:src="${concert.image} ?: '/uploads/default_profile.png'"
                 alt="Concert display picture"
                 style="width:160px;height:160px;object-fit:cover;"/>
        </div>
        <div class="header-box">
            <h4 th:text="${concert.concertDate}"></h4>
            <h1 th:text="${concert.concertName} ? ${concert.concertName} : ${concert.artist.name} + ' at ' + ${venue.venueName}"></h1>
            <h4 th:text="'ðŸ“ ' + ${venue.venueName} + ': ' + ${venue.address} + ', ' + ${venue.city} + ', ' + ${venue.country}"></h4>
            <h4 th:text="${concert.startTime} ? 'ðŸ•• ' + ${concert.startTime} : ''"></h4>
            <div id="concert-lineup">
                <span style="font-weight: 800;">LINEUP â†’</span>

                <div class="artist-tags">
                    <span th:each="artist, iterStat : ${lineup}">
                        <a th:href="@{/artists/{id}(id=${artist.id})}"
                           th:text="${artist.name}"
                           class="artist-link">
                        </a>
                        <!-- Admin-only: edit concert details -->
<!-- <div th:if="${canEditConcert}" class="admin-edit">
  <details class="admin-edit__details">
    <summary class="admin-edit__btn">Edit concert</summary>

    <form class="admin-edit__form"
          th:action="@{/concerts/{id}/edit(id=${concert.id})}"
          method="post"
          th:object="${concertEdit}">

      <input type="hidden" th:if="${_csrf != null}"
             th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

      <label>Concert name</label>
      <input type="text" th:field="*{concertName}" placeholder="Optional name (e.g. BUTTERFLY)" />

      <label>Date</label>
      <input type="date" th:field="*{concertDate}" />

      <label>Start time</label>
      <input type="time" th:field="*{startTime}" />

        <!-- If you want to edit venue details without changing shared Venue records,
             put these as override fields on Concert (recommended).
             If you DON'T have overrides yet, skip these 4 fields. -->
<!--       <label>Venue name</label>
      <input type="text" th:field="*{overrideVenueName}" />

      <label>Address</label>
      <input type="text" th:field="*{overrideVenueAddress}" />

      <label>City</label>
      <input type="text" th:field="*{overrideVenueCity}" />

      <label>Country</label>
      <input type="text" th:field="*{overrideVenueCountry}" />

      <button type="submit">Save</button>
    </form>
  </details>
</div> -->


                        <span th:if="${!iterStat.last}" class="separator"> | </span>
                    </span>
                    <span th:if="${#lists.isEmpty(lineup)}">
                        <a th:href="@{/artists/{id}(id=${concert.artist.id})}"
                           th:text="${concert.artist.name}"
                           class="artist-link">
                        </a>
                    </span>
                </div>
            </div>
        </div>
        <div>
            <button th:id="rsvp-btn"
                    th:data-concert-id="${concert.id}"
                    th:class="${isGoing} ? 'active' : ''">
            <span class="custom-checkbox">
                <span class="tick-mark"></span>
            </span>
                <span th:id="rsvp-btn-text"
                      th:text="RSVP">
            </span>
            </button>
        </div>
    </div>
</div>

<!-- Main -->
<div class="page-layout extended-page-layout">

    <!-- middle column-->
    <main class="right-column" id="concert_tabs">

        <input type="radio" name="profile-tabs" id="tab-concert-posts" checked>
        <input type="radio" name="profile-tabs" id="tab-concert-crowd">
        <input type="radio" name="profile-tabs" id="tab-concert-gallery">

        <nav class="nav-bar">
            <label for="tab-concert-posts">Feed</label>
            <label for="tab-concert-crowd">Crowd</label>
            <label for="tab-concert-gallery">Gallery</label>
        </nav>

        <section class="tab-content" id="content-concert-posts">
            <div class="box">
                <div class="box">
                    <form id="new-post-form" th:action="@{/concerts/{id}/posts(id=${concert.id})}" th:object="${post}" method="post" enctype="multipart/form-data">
                        <label class="label" for="post-content" aria-hidden="false"></label>
                        <textarea
                                id="post-content"
                                rows="3"
                                th:field="*{content}"
                                th:placeholder="'Join the conversation...'"></textarea>

                        <input type="hidden" th:field="*{mediaUrl}" id="mediaUrl">
                        <input type="hidden" th:field="*{mediaType}" id="mediaType">

                        <div class="mb-3">
                            <input type="file"
                                   class="form-control mb-3"
                                   id="media_file"
                                   name="media_file"
                                   accept="image/*, video/*, audio/*">
                            <button type="button"
                                    id="clearMediaBtn"
                                    class="btn btn-outline-secondary btn-sm mt-2 d-none">
                                Remove selected file
                            </button>
                            <div id="uploadWrapper" class="mt-3 d-none">
                                <div class="progress">
                                    <div id="uploadProgressBar"
                                         class="progress-bar"
                                         role="progressbar"
                                         style="width: 0%;">0%</div>
                                </div>
                                <small id="uploadStatus" class="text-muted d-block mt-2">Uploadingâ€¦</small>
                            </div>
                        </div>
                        <div th:if="${#fields.hasErrors('content')}" th:errors="*{content}"></div>
                        <button id="post-submit" type="submit" onclick="console.log('SUBMIT CLICKED')">Post</button>
                    </form>
                </div>
                <div class="box concert-posts">

                    <div class="feed-post box" th:each="post : ${posts}">
                    <ul>
                        <li th:each="post : ${posts}" class="mb-3">
                            <p th:text="${post.artist} ? ${post.artist.name} + ':' : ${post.user.username} + ':'"></p>
                            <p style="white-space: pre-wrap;" th:text="${post.content} + ' â€“ Posted at ' + ${#temporals.format(post.timestamp, 'yyyy-MM-dd HH:mm:ss', userTimezone)}"></p>
                            <div th:if="${post.mediaUrl != null}">

                        <!-- Header row -->
                        <div class="post-header">
                            <h3 th:text="${post.artist != null ? post.artist.name : post.user.username}"></h3>
                            <span class="post-time"
                                  th:text="${#temporals.format(post.timestamp, 'yyyy-MM-dd HH:mm:ss', userTimezone)}">
      </span>
                        </div>
                        <div class="post-bubble"
                             style="white-space: pre-wrap;"
                             th:text="${post.content}">
                        </div>

                        <img th:if="${post.mediaType == 'image'}"
                                     th:src="${post.mediaUrl}"
                                     alt="Post image"
                                     style="width: 50%; height: auto; object-fit: cover;">

                                <video th:if="${post.mediaType == 'video'}"
                                       th:src="${post.mediaUrl}"
                                       controls
                                       style="width: 100%; height: auto; object-fit: cover;">
                                </video>

                                <audio th:if="${post.mediaType == 'audio'}"
                                       th:src="${post.mediaUrl}"
                                       controls>
                                </audio>

                            </div>
                        </li>
                    </ul>
                    <p th:if="${#lists.isEmpty(posts)}">No posts yet. Say hello!</p>
                </div>
            </div>
        </section>

        <section class="tab-content" id="content-concert-crowd">
            <div class="box">
                <ul style="display: flex;" th:class="user-list">
                    <li th:id="attendee-current-user"
                        th:class="${isGoing} ? 'active' : 'hidden'">
                        <div th:replace="~{fragments/display-card :: displayCard(
                            ${currentUser.username},
                            '/user',
                            ${currentUser.avatar != null ? currentUser.avatar : 'https://placehold.co/128'},
                            'Picture of ' + ${currentUser.username}
                            )}">
                        </div>
                    </li>
                    <li th:each="user: ${crowd}"
                        th:id="'attendee-' + ${user.id}"
                        th:unless="${user.id == currentUser.id}">
                        <div th:replace="~{fragments/display-card :: displayCard(
                            ${user.username},
                            '/users/' + ${user.id},
                            ${user.avatar != null ? user.avatar : 'https://placehold.co/128'},
                            'Picture of ' + ${user.username}
                            )}">
                        </div>
                    </li>
                </ul>
                <p th:id="no-rsvp-message" th:class="${#lists.isEmpty(crowd)} ? 'active' : 'hidden'">No one's RSVP'd yet. Be the first to join!</p>
            </div>
        </section>

        <section class="tab-content" id="content-concert-gallery">
            <div class="box">
                <p th:if="${#lists.isEmpty(mediaPosts)}">No photos or videos yet. Capture and share your concert memories!</p>
                <div class="gallery-grid" th:if="${!#lists.isEmpty(mediaPosts)}">
                    <div th:each="post : ${mediaPosts}"
                         th:if="${post.mediaType == 'image' || post.mediaType == 'video'}"
                         th:class="gallery-item">
                        <img th:if="${post.mediaType == 'image'}"
                             th:src="${post.mediaUrl}"
                             alt="Concert image"
                             class="gallery-media"
                             onclick="openModal(this)"
                             th:data-author="${post.artist} ? ${post.artist.name} + ':' : ${post.user.username} + ':'"
                             th:data-caption="${post.content}"
                             th:data-type="'image'"
                             style="cursor: pointer;">

                        <div th:if="${post.mediaType == 'video'}" class="video-container" style="position: relative; width: 100%; height: 100%;">
                            <video th:src="${post.mediaUrl}"
                                   controls
                                   class="gallery-media"
                                   th:data-author="${post.artist} ? ${post.artist.name} : ${post.user.username} + ':'"
                                   th:data-caption="${post.content}"
                                   th:data-type="'video'">
                            </video>

                            <div class="modal-trigger-overlay"
                                 onclick="openModal(this.previousElementSibling)"
                                 style="position: absolute; top: 0; left: 0; width: 100%; height: 60%; cursor: pointer;">
                            </div>
                        </div>
                    </div>
                </div>

                <!--Media Modal (Pop Up)-->
                <div id="galleryModal" class="modal-overlay" onclick="closeModal()">
                    <span class="close-btn">&times;</span>
                    <div class="modal-content" onclick="event.stopPropagation()">

                        <img id="modalImg" src="" alt="Full view" style="display: none; width: 100%;">

                        <video id="modalVideo" controls playsinline style="display: none; width: 100%; max-height: 70vh; background: black;">
                            Your browser does not support the video tag.
                        </video>

                        <div class="modal-info">
                            <h4 id="modalAuthor"></h4>
                            <p id="modalCaption"></p>
                        </div>
                    </div>
                </div>
              </div>
            </div>
        </section>

    </main>

</div>
</body>
</html>