<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Concert</title>

    <link rel="stylesheet" href="/main.css" />
    <link rel="stylesheet" href="/two-column-pages.css" />
    <link rel="stylesheet" href="/concerts.css" />
    <link rel="stylesheet" href="/navbar.css"/>
    <th:block th:replace="~{fragments/timezone-script :: timezone-detector}"></th:block>
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <script src="/js/rsvp.js" defer></script>
    <script src="/js/posts.js" defer></script>
    <script src="/js/concertGallery.js" defer></script>
</head>
<header class="page-header">
    <div th:insert="~{fragments/navbar :: headerNav}"></div>
</header>
<body>

<!-- Header -->
<div class="concert-header">
    <h1 th:text="${concert.concertName} ? ${concert.concertName} : ${concert.artist.name} + ' at ' + ${venue.venueName}"></h1>
    <h3 th:text="${concert.concertDate}"></h3>
    <button th:id="rsvp-btn"
            th:data-concert-id="${concert.id}"
            th:class="${isGoing} ? 'active' : ''">
        <span class="custom-checkbox">
            <span class="tick-mark"></span>
        </span>
        <span th:id="rsvp-btn-text"
              th:text="RSVP">
        </span>
    </button>
</div>

<!-- Main -->
<div class="page-layout">

    <!-- Left column -->
    <aside class="left-column">

        <div class="box profile-picture">
            <img
                 class="rounded-circle border border-3 border-white shadow-sm"
                 style="width: 160px; height: 160px; object-fit: cover;">
        </div>

        <div class="box">
            <h3>Key Information</h3>
            <h4 th:text="'Venue: ' + ${venue.venueName}"></h4>
            <h4 th:text="${concert.startTime} ? 'Start time: ' + ${concert.startTime} : ''"></h4>
            <h4>Address:</h4>
            <p th:text="${venue.address}"></p>
            <p th:text="${venue.city}"></p>
            <p th:text="${venue.country}"></p>
        </div>

        <div class="box">
            <h3>Lineup</h3>
            <p>Artists go here</p>
        </div>

    </aside>

    <!-- middle column-->
    <main class="right-column" id="concert_tabs">

        <input type="radio" name="profile-tabs" id="tab-concert-posts" checked>
        <input type="radio" name="profile-tabs" id="tab-concert-crowd">
        <input type="radio" name="profile-tabs" id="tab-concert-gallery">

        <nav class="nav-bar">
            <label for="tab-concert-posts">Feed</label>
            <label for="tab-concert-crowd">Crowd</label>
            <label for="tab-concert-gallery">Gallery</label>
        </nav>

        <section class="tab-content" id="content-concert-posts">
            <div class="box">
                <h3>Feed</h3>
                <div class="box">
                    <form id="new-post-form" th:action="@{/concerts/{id}/posts(id=${concert.id})}" th:object="${post}" method="post" enctype="multipart/form-data">
                        <label class="label" for="post-content" aria-hidden="false">Content</label>
                        <textarea
                                id="post-content"
                                rows="3"
                                th:field="*{content}"
                                th:placeholder="'Join the conversation...'"></textarea>

                        <input type="hidden" th:field="*{mediaUrl}" id="mediaUrl">
                        <input type="hidden" th:field="*{mediaType}" id="mediaType">

                        <div class="mb-3">
                            <input type="file"
                                   class="form-control mb-3"
                                   id="media_file"
                                   name="media_file"
                                   accept="image/*, video/*, audio/*">
                            <button type="button"
                                    id="clearMediaBtn"
                                    class="btn btn-outline-secondary btn-sm mt-2 d-none">
                                Remove selected file
                            </button>
                            <div id="uploadWrapper" class="mt-3 d-none">
                                <div class="progress">
                                    <div id="uploadProgressBar"
                                         class="progress-bar"
                                         role="progressbar"
                                         style="width: 0%;">0%</div>
                                </div>
                                <small id="uploadStatus" class="text-muted d-block mt-2">Uploading…</small>
                            </div>
                        </div>
                        <div th:if="${#fields.hasErrors('content')}" th:errors="*{content}"></div>
                        <button id="post-submit" type="submit" onclick="console.log('SUBMIT CLICKED')">Post</button>
                    </form>
                </div>
                <div class="box">
                    <ul>
                        <li th:each="post : ${posts}" class="mb-3">
                            <p th:text="${post.artist} ? ${post.artist.name} + ':' : ${post.user.username} + ':'"></p>
                            <p style="white-space: pre-wrap;" th:text="${post.content} + ' – Posted at ' + ${#temporals.format(post.timestamp, 'yyyy-MM-dd HH:mm:ss', userTimezone)}"></p>
                            <div th:if="${post.mediaUrl != null}">

                                <img th:if="${post.mediaType == 'image'}"
                                     th:src="${post.mediaUrl}"
                                     alt="Post image"
                                     style="width: 50%; height: auto; object-fit: cover;">

                                <video th:if="${post.mediaType == 'video'}"
                                       th:src="${post.mediaUrl}"
                                       controls
                                       style="width: 100%; height: auto; object-fit: cover;">
                                </video>

                                <audio th:if="${post.mediaType == 'audio'}"
                                       th:src="${post.mediaUrl}"
                                       controls>
                                </audio>

                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </section>

        <section class="tab-content" id="content-concert-crowd">
            <div class="box">
                <h3>Crowd</h3>
                <ul style="display: flex;" th:class="user-list">
                    <li th:id="attendee-current-user"
                        th:class="${isGoing} ? 'active' : 'hidden'">
                        <div th:replace="~{fragments/display-card :: displayCard(
                            ${currentUser.username},
                            '/user',
                            ${currentUser.avatar != null ? currentUser.avatar : 'https://placehold.co/128'},
                            'Picture of ' + ${currentUser.username}
                            )}">
                        </div>
                    </li>
                    <li th:each="user: ${crowd}"
                        th:id="'attendee-' + ${user.id}"
                        th:unless="${user.id == currentUser.id}">
                        <div th:replace="~{fragments/display-card :: displayCard(
                            ${user.username},
                            '/users/' + ${user.id},
                            ${user.avatar != null ? user.avatar : 'https://placehold.co/128'},
                            'Picture of ' + ${user.username}
                            )}">
                        </div>
                    </li>
                </ul>
            </div>
        </section>

        <section class="tab-content" id="content-concert-gallery">
            <div class="box">
                <h3>Gallery</h3>
                <div class="gallery-grid">
                    <div th:each="post : ${posts}"
                         th:if="${post.mediaType == 'image' || post.mediaType == 'video'}"
                         th:class="gallery-item">
                        <img th:if="${post.mediaType == 'image'}"
                             th:src="${post.mediaUrl}"
                             alt="Concert image"
                             class="gallery-media"
                             onclick="openModal(this)"
                             th:data-author="${post.artist} ? ${post.artist.name} + ':' : ${post.user.username} + ':'"
                             th:data-caption="${post.content}"
                             th:data-type="'image'"
                             style="cursor: pointer;">

                        <div th:if="${post.mediaType == 'video'}" class="video-container" style="position: relative; width: 100%; height: 100%;">
                            <video th:src="${post.mediaUrl}"
                                   controls
                                   class="gallery-media"
                                   th:data-author="${post.artist} ? ${post.artist.name} : ${post.user.username}"
                                   th:data-caption="${post.content}"
                                   th:data-type="'video'">
                            </video>

                            <div class="modal-trigger-overlay"
                                 onclick="openModal(this.previousElementSibling)"
                                 style="position: absolute; top: 0; left: 0; width: 100%; height: 60%; cursor: pointer;">
                            </div>
                        </div>
                    </div>
                </div>

                <!--Media Modal (Pop Up)-->
                <div id="galleryModal" class="modal-overlay" onclick="closeModal()">
                    <span class="close-btn">&times;</span>
                    <div class="modal-content" onclick="event.stopPropagation()">

                        <img id="modalImg" src="" alt="Full view" style="display: none; width: 100%;">

                        <video id="modalVideo" controls playsinline style="display: none; width: 100%; max-height: 70vh; background: black;">
                            Your browser does not support the video tag.
                        </video>

                        <div class="modal-info">
                            <h4 id="modalAuthor"></h4>
                            <p id="modalCaption"></p>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </section>

    </main>

</div>
</body>
</html>