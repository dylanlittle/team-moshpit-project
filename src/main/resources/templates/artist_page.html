<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${artist.name}">Artist Profile</title>
    <link rel="stylesheet" href="/main.css" />
    <link rel="stylesheet" href="/navbar.css"/>
    <link rel="stylesheet" href="/artist-profile.css"/>
    <link rel="stylesheet" href="/user-profile.css"/>
    <link rel="stylesheet" href="/theme.css"/>
    <link rel="stylesheet" href="/index.css"/>
    <th:block th:replace="~{fragments/timezone-script :: timezone-detector}"></th:block>
    <script src="/js/posts.js" defer></script>
    <script src="/js/dates_toggle.js" defer></script>
</head>

<body>
  
<!-- Navbar -->
<header class="page-header">
    <div th:insert="~{fragments/navbar :: headerNav}"></div>
</header>

<!-- Artist header-->
<!-- header box -->
<div class="header-layout">
    <div class="box user-header">
        <!-- profile picture -->
        <div class="header-box profile-picture">
            <img th:src="${artist.avatar} ?: '/uploads/default_profile.png'"
                 alt="Artist profile picture"
                 style="width:160px;height:160px;object-fit:cover;"/>
        </div>
        <!-- account type, name, username, bio and location -->
        <div class="header-box">
            <!-- Account type-->
            <h4>Artist account</h4>
            <!-- Name -->
            <h1 th:text="${artist.name}"></h1>
            <!-- Genre -->
            <div class="artist-genre" th:text="${artist.genre}"></div>
            <!-- Bio -->
            <p th:text="${artist.bio}"></p>
        </div>
        <!-- Follow button -->
        <div>
            <form th:if="${!isAdminMode}" th:action="${isFollowing} ? @{/artists/{id}/unfollow(id=${artist.id})} : @{/artists/{id}/follow(id=${artist.id})}" method="post">
                <button type="submit"
                        th:text="${isFollowing} ? 'Unfollow' : 'Follow'"
                        th:class="${isFollowing} ? 'btn-secondary' : 'btn-secondary'">
                </button>
            </form>
        </div>
    </div>
<!-- Artist header end -->
<!--<div class="artist-header">
    <h1 th:text="${artist.name}"></h1>
    <div class="artist-genre" th:text="${artist.genre}"></div>
    <form th:if="${!isAdminMode}" th:action="${isFollowing} ? @{/artists/{id}/unfollow(id=${artist.id})} : @{/artists/{id}/follow(id=${artist.id})}" method="post">
        <button type="submit"
                th:text="${isFollowing} ? 'Unfollow' : 'Follow'"
                th:class="${isFollowing} ? 'btn-secondary' : 'btn-primary'">
        </button>
    </form>-->
    <button th:if="${isAdminMode and activeAdminArtist.id == artist.id}" onclick="document.getElementById('adminPanel').showModal()">Admins</button>
    <div th:if="${isAdminMode and activeAdminArtist.id == artist.id}">
        <a th:href="@{/artists/{id}/update(id=${artist.id})}">
            <button>Edit artist profile</button>
        </a>
    </div>
    <a th:if="${isAdminMode and activeAdminArtist.id == artist.id}"
       th:href="@{/artists/{id}/spotify/link(id=${artist.id})}"
       class="btn btn-outline-secondary"
       th:text="${artist.spotifyArtistId != null} ? 'Spotify linked ✓' : 'Link Spotify'">
        Link Spotify
    </a>
</div>

    <!-- Main -->
    <div class="page-layout">

    <!-- Left colum -->
    <aside class="left-column">

        <!--<div class="box profile-picture">
            <img th:src="${artist.avatar} ?: '/uploads/default_profile.png'"
                 alt="Artist profile picture"
                 style="width:160px;height:160px;object-fit:cover;"/>
        </div>-->

        <div class="box" th:if="${relationshipStats != null and !isAdminMode}">
            <h3>Your relationship with this artist</h3>

            <div th:if="${!relationshipStats.connected}">
                <p>Connect Spotify to see your relationship with this artist.</p>
                <a th:href="@{/spotify/connect}" class="btn btn-success">Connect Spotify</a>
            </div>

            <div th:if="${relationshipStats.connected}">
                <p th:if="${relationshipStats.inTopArtists}">
                    Appears in your Top Artists
                    <span th:if="${relationshipStats.topArtistRank != null}"
                          th:text="'(#' + ${relationshipStats.topArtistRank} + ')'"></span>
                </p>

                <p th:if="${!relationshipStats.inTopArtists}">
                    Not in your Top Artists for this time range.
                </p>

                <p th:if="${relationshipStats.savedTracksCount != null}"
                   th:text="'Saved tracks by this artist: ' + ${relationshipStats.savedTracksCount}"></p>

                <p th:if="${relationshipStats.lastListenedAt != null}">
                    Last listened:
                    <span th:text="${#temporals.format(relationshipStats.lastListenedAt, 'dd MMM yyyy HH:mm')}"></span>
                </p>

                <div th:if="${relationshipStats.topTracksByArtist != null and !#lists.isEmpty(relationshipStats.topTracksByArtist)}">
                    <ul style="list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px;">
                        <li th:each="t : ${relationshipStats.topTracksByArtist}"
                            style="display:flex; align-items:center; gap:10px;">
                            <img th:if="${t.albumImageUrl != null}"
                                 th:src="${t.albumImageUrl}"
                                 style="width:44px;height:44px;border-radius:10px;object-fit:cover;"/>
                            <div style="display:flex; flex-direction:column;">
                                <span th:text="${t.name}" style="font-weight:600;"></span>
                                <a th:if="${t.spotifyUrl != null}" th:href="${t.spotifyUrl}" target="_blank"
                                   style="font-size:0.9em; opacity:0.8;">Open on Spotify</a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

    </aside>

    <!-- middle column-->
    <main class="middle-column" id="fan-feed">

        <div class="box" th:if="${isAdminMode and activeAdminArtist.id == artist.id}">
            <form id="new-post-form" th:action="@{/artists/{id}/posts(id=${artist.id})}" th:object="${post}" method="post" enctype="multipart/form-data">
                <label class="label" for="post-content" aria-hidden="false">Content</label>
                <textarea
                        id="post-content"
                        rows="3"
                        th:field="*{content}"
                        th:placeholder="'Share an update with your fans...'"></textarea>

                <input type="hidden" th:field="*{mediaUrl}" id="mediaUrl">
                <input type="hidden" th:field="*{mediaType}" id="mediaType">

                <div class="mb-3">
                    <input type="file"
                           class="form-control mb-3"
                           id="media_file"
                           name="media_file"
                           accept="image/*, video/*, audio/*">
                    <button type="button"
                            id="clearMediaBtn"
                            class="btn btn-outline-secondary btn-sm mt-2 d-none">
                        Remove selected file
                    </button>
                    <div id="uploadWrapper" class="mt-3 d-none">
                        <div class="progress">
                            <div id="uploadProgressBar"
                                 class="progress-bar"
                                 role="progressbar"
                                 style="width: 0%;">0%</div>
                        </div>
                        <small id="uploadStatus" class="text-muted d-block mt-2">Uploading…</small>
                    </div>
                </div>
                <div th:if="${#fields.hasErrors('content')}" th:errors="*{content}"></div>
                <button id="post-submit" type="submit" onclick="console.log('SUBMIT CLICKED')">Post</button>
            </form>
        </div>

        <div class="box">
            <ul>
                <li th:each="post : ${posts}" class="mb-3">
                    <p style="white-space: pre-wrap;" th:text="${post.content} + ' – Posted at ' + ${#temporals.format(post.timestamp, 'yyyy-MM-dd HH:mm:ss', userTimezone)}"></p>
                    <div th:if="${post.mediaUrl != null}">

                        <img th:if="${post.mediaType == 'image'}"
                             th:src="${post.mediaUrl}"
                             alt="Post image"
                             style="width: 50%; height: auto; object-fit: cover;">

                        <video th:if="${post.mediaType == 'video'}"
                               th:src="${post.mediaUrl}"
                               controls
                               style="width: 100%; height: auto; object-fit: cover;">
                        </video>

                        <audio th:if="${post.mediaType == 'audio'}"
                               th:src="${post.mediaUrl}"
                               controls>
                        </audio>

                    </div>
                </li>
            </ul>
        </div>


    </main>

    <div th:replace="~{fragments/action-dialogue :: dialog(
      title='Admins',
      id='adminPanel',
      cta_link=@{/artists/{id}/newAdmin(id=${artist.id})},
      cta='Add new admin',
      content=(~{::adminList})
    )}">
        <div th:fragment="adminList">
            <ul style="display: flex; margin: 12px 0; flex-wrap: wrap; gap: 10px;">
                <li th:each="admin : ${admins}">
                    <div style="position: relative;">
                        <div th:replace="~{fragments/display-card :: displayCard(
                        ${admin.user.name},
                         '/users/' + ${admin.user.id},
                          ${admin.user.avatar} ?: '/uploads/default_profile.png',
                          'Picture of admin'
                          )}">
                        </div>

                        <form th:if="${admin.role.toString() == 'ADMIN'}"
                              th:action="@{/artists/{artistId}/admin/{adminId}(artistId=${artist.id}, adminId=${admin.id})}"
                              method="post"
                              style="position: absolute; top: 5px; right: 5px; margin: 0;"
                              class="remove-admin-form">
                            <input type="hidden" name="_method" value="DELETE"/>
                            <button type="submit"
                                    th:attr="onclick=|return confirm('Remove ${admin.user.name} as admin?')|"                                    class="btn btn-sm btn-danger"
                                    style="font-size: 10px; padding: 2px 6px;"
                                    title="Remove admin">×</button>
                        </form>
                    </div>
                </li>
            </ul>
        </div>

    </div>

    <!-- right column
     fan wall could be carousel of images/videos of fans, maybe they tag artist and they show up here.-->
    <aside class="right-column">

        <div class="box">
            <label for="dates-selector" class="visually-hidden">
                Show dates:
            </label>
            <select id="dates-selector">
                <option value="upcoming" selected>Upcoming Shows</option>
                <option value="previous">Previous Shows</option>
            </select>
        </div>


        <div class="box concerts-column" id="upcoming-dates">
            <!--<div th:class="concerts-column">-->
                <div class="feed-post box" th:each="concert:${futureConcerts}">
                    <div>
                        <a th:href="@{/artists/{id}(id=${concert.artist.id})}">
                            <h2 th:text="${artist.name}"></h2>
                        </a>
                        <h3 th:text="${concert.venue.venueName}"></h3>
                        <p th:text="${#temporals.format(concert.concertDate, 'dd MMM yyyy')} + ' - ' + ${concert.venue.city} + ', ' + ${concert.venue.country}"></p>
                    </div>
                </div>
            <!--</div>-->
            <p th:if="${#lists.isEmpty(futureConcerts)}">No upcoming shows.</p>
            <a th:if="${isAdminMode and activeAdminArtist.id == artist.id}" th:href="@{/artists/{id}/concerts/new(id=${artist.id})}" ><button>Add new date</button></a>
        </div>

        <div class="box concerts-column" id="previous-dates" hidden>
            <!--<div th:class="concerts-column">-->
                <div class="feed-post box" th:each="concert:${pastConcerts}">
                    <div>
                        <a th:href="@{/artists/{id}(id=${concert.artist.id})}">
                            <h2 th:text="${artist.name}"></h2>
                        </a>
                        <h3 th:text="${concert.venue.venueName}"></h3>
                        <p th:text="${#temporals.format(concert.concertDate, 'dd MMM yyyy')} + ' - ' + ${concert.venue.city} + ', ' + ${concert.venue.country}"></p>
                    </div>
                </div>
                <!--</div>-->
                <p th:if="${#lists.isEmpty(pastConcerts)}">No previous shows.</p>
                <a th:if="${isAdminMode and activeAdminArtist.id == artist.id}" th:href="@{/artists/{id}/concerts/new(id=${artist.id})}" ><button>Add new date</button></a>
           <!-- </div>-->
        </div>
    </aside>
    </div>
</body>
</html>
                    <!--<div class="box upcoming-dates" id="previous-dates" hidden>
                    <div class="concert-card" th:each="concert : ${pastConcerts}">
                        <span class="concert-pin"></span>

                        <a th:href="@{/concerts/{id}(id=${concert.id})}">
                            <h4 th:text="${artist.name}"></h4>
                            <h5 th:text="${concert.venue.venueName}"></h5>
                            <p th:text="${#temporals.format(concert.concertDate,'dd MMM yyyy')} + ' - ' + ${concert.venue.city} + ', ' + ${concert.venue.country}">
                            </p>
                        </a>
                    </div>

                    <a th:if="${isAdminMode and activeAdminArtist.id == artist.id}" th:href="@{/artists/{id}/concerts/new(id=${artist.id})}" ><button>Add new date</button></a>-->


