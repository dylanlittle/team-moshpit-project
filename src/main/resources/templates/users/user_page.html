<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${user.name}">User Profile</title>

    <link rel="stylesheet" href="/main.css" />
    <link rel="stylesheet" href="/two-column-pages.css" />
    <link rel="stylesheet" href="/navbar.css"/>
</head>
<header class="page-header">
    <div th:insert="~{fragments/navbar :: headerNav}"></div>
</header>
<body>

<div class="user-header">

    <h1 th:text="${user.name}"></h1>
    <h3 th:text="'@' + ${user.username}"></h3>
    <h4>Fan account</h4>
    <div th:if="${user.spotifyRefreshToken == null}">
        <a th:href="@{/spotify/connect}" class="btn btn-success">Connect Spotify</a>
    </div>
    <div th:unless="${user.spotifyRefreshToken == null}">
        <form th:action="@{/spotify/disconnect}" method="post">
            <button class="btn btn-outline-danger" type="submit">Disconnect Spotify</button>
        </form>
        <p></p>
    </div>

    <div th:if="${!editing}">
        <a th:if="${isOwner}"
           th:href="@{/users/{id}/edit(id=${user.id})}">
            <button>Edit Profile</button>
        </a>
    </div>

    <form th:if="${editing}"
          th:action="@{/users/{id}(id=${user.id})}"
          method="post"
          enctype="multipart/form-data">

        <label>Username</label>
        <input type="text"
               name="username"
               th:value="${user.username}"
               required/>

        <div class="actions">
            <button type="submit">Save Changes</button>
            <a th:href="@{/users/{id}(id=${user.id})}">
                <button type="button">Cancel</button>
            </a>
        </div>
    </form>
</div>


<div class="page-layout">

    <aside class="left-column">


        <div class="box profile-picture">

            <!-- Hides old image when changing profile picture -->
            <img th:if="${!editing}"
                 th:src="${user.avatar} ?: '/uploads/default_profile.png'"
                 alt="Profile picture"
                 style="width:160px;height:160px;object-fit:cover;"/>

            <div th:if="${editing}">
                <label>Change profile image</label>
                <input type="file" name="image" accept="image/*"/>
            </div>
        </div>


        <div class="box">
            <h3>About Me</h3>
            <p th:if="${!editing}" th:text="${user.bio}"></p>
            <textarea th:if="${editing}"
                      name="bio"
                      rows="4"
                      th:text="${user.bio}"></textarea>

            <div th:if="${user.location}">
                <p th:text="'ðŸ“ ' + ${user.location}"></p>
            </div>
        </div>


        <div class="box">
            <h3>Spotify</h3>
            <p>Spotify embed will go here.</p>
        </div>


        <div class="box">
            <h3>Top Artists</h3>

            <div th:if="${user.spotifyRefreshToken == null}">
                <p>Connect Spotify to show your top artists.</p>
            </div>

            <div th:if="${user.spotifyRefreshToken != null and (spotifyTopArtists == null or #lists.isEmpty(spotifyTopArtists))}">
                <p>No top artists returned yet. Try listening on Spotify and check again later.</p>
            </div>

            <div th:if="${user.spotifyRefreshToken != null}">
                <form method="get" th:action="@{/user}" style="margin-bottom: 10px;">
                    <label for="timeRange" style="display:block; margin-bottom:4px;">
                        Time range
                    </label>
                    <select id="timeRange" name="timeRange" onchange="this.form.submit()">
                        <option value="short_term"
                                th:selected="${timeRange == 'short_term'}">
                            Last 4 weeks
                        </option>
                        <option value="medium_term"
                                th:selected="${timeRange == 'medium_term'}">
                            Last 6 months
                        </option>
                        <option value="long_term"
                                th:selected="${timeRange == 'long_term'}">
                            All time-ish
                        </option>
                    </select>
                </form>
            </div>

            <ul th:if="${spotifyTopArtists != null and !#lists.isEmpty(spotifyTopArtists)}">
                <li th:each="a : ${spotifyTopArtists}">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <img th:if="${a.images != null and !#lists.isEmpty(a.images)}"
                             th:src="${a.images.get(0).url}"
                             style="width:40px; height:40px; border-radius:8px; object-fit:cover;" />

                        <div style="display:flex; flex-direction:column;">
                            <span th:text="${a.name}">Artist Name</span>

                            <a th:if="${spotifySuggestions != null and spotifySuggestions.containsKey(a.id)}"
                               th:href="@{/artists/{id}(id=${spotifySuggestions.get(a.id).id})}">
                                View on Mosh Pit
                            </a>

                            <span th:unless="${spotifySuggestions != null and spotifySuggestions.containsKey(a.id)}"
                                  style="opacity:0.7; font-size:0.9em;">
                        Not on Mosh Pit yet
                    </span>
                        </div>
                    </div>
                </li>
            </ul>
        </div>


        <div class="box">
            <h3>Currently Listening</h3>
            <ol>
                <li>Spacey Jane â€“ Through My Teeth</li>
            </ol>
        </div>

    </aside>

    <main class="right-column" id="fan-feed">

        <input type="radio" name="profile-tabs" id="tab-followed" checked>
        <input type="radio" name="profile-tabs" id="tab-history">
        <input type="radio" name="profile-tabs" id="tab-posts">

        <nav class="nav-bar">
            <label for="tab-followed">Followed Artists</label>
            <label for="tab-history">History</label>
            <label for="tab-posts">Posts</label>
        </nav>

        <section class="tab-content" id="content-followed">
            <div class="box">
                <h3>Followed Artists</h3>
                <p>You aren't following anyone yet.</p>
            </div>
        </section>

        <section class="tab-content" id="content-history">
            <div class="box">
                <h3>Recent History</h3>
                <p>No recent activity found.</p>
            </div>
        </section>

        <section class="tab-content" id="content-posts">
            <div class="box">
                <h3>Posts</h3>

                <ul th:if="${posts != null and !#lists.isEmpty(posts)}"
                    th:each="post : ${posts}">
                    <li th:text="${post.content}"></li>
                </ul>

                <p th:if="${posts == null or #lists.isEmpty(posts)}">
                    No posts yet.
                </p>
            </div>
        </section>

    </main>

</div>

</form>

</body>
</html>
