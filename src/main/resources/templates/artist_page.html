<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${artist.name}">Artist Profile</title>
    <link rel="stylesheet" href="/main.css" />
    <th:block th:replace="~{fragments/timezone-script :: timezone-detector}"></th:block>
</head>

<body>

<!-- Header -->
<div class="artist-header">
    <h1 th:text="${artist.name}">Cameron Winter</h1>
    <div class="artist-genre" th:text="${artist.genre}">Folk / Alternative</div>
</div>

<!-- Temp nav bar
 fan feed could be live stream of thoughts from fans, helps with bringing the community together idea?-->
<div class="nav-bar">
    <a href="#bio">Bio</a>
    <a href="#tours">Tours</a>
    <a href="#merch">Merch</a>
    <a href="#media">Media</a>
    <a href="#fan-feed">Fan feed</a>
    <button th:if="${isAdmin}" onclick="document.getElementById('adminPanel').showModal()">Admins</button>
</div>

<!-- Main -->
<div class="page-layout">

    <!-- Left colum -->
    <aside class="left-column">

        <div class="box profile-picture">
            Artist profile picture
        </div>

        <div class="box">
            <h3>Spotify</h3>
            <p>Spotify embed will go here.</p>
        </div>

        <div class="box">
            <h3>Bio</h3>
            <p th:text="${artist.bio}"></p>
        </div>

    </aside>

    <!-- middle column-->
    <main class="middle-column" id="fan-feed">

        <div class="box">
            <form id="new-post-form" th:action="@{/artists/{id}/posts(id=${artist.id})}" th:object="${post}" method="post" enctype="multipart/form-data">
                <label class="label" for="post-content" aria-hidden="false">Content</label>
                <textarea
                        id="post-content"
                        rows="3"
                        th:field="*{content}"
                        th:placeholder="'Share an update with your fans...'"></textarea>

                <input type="hidden" th:field="*{mediaUrl}" id="mediaUrl">
                <input type="hidden" th:field="*{mediaType}" id="mediaType">

                <div class="mb-3">
                    <input type="file"
                           class="form-control mb-3"
                           id="media_file"
                           name="media_file"
                           accept="image/*, video/*, audio/*">
                    <button type="button"
                            id="clearMediaBtn"
                            class="btn btn-outline-secondary btn-sm mt-2 d-none">
                        Remove selected file
                    </button>
                    <div id="uploadWrapper" class="mt-3 d-none">
                        <div class="progress">
                            <div id="uploadProgressBar"
                                 class="progress-bar"
                                 role="progressbar"
                                 style="width: 0%;">0%</div>
                        </div>
                        <small id="uploadStatus" class="text-muted d-block mt-2">Uploading…</small>
                    </div>
                </div>
                <div th:if="${#fields.hasErrors('content')}" th:errors="*{content}"></div>
                <button id="post-submit" type="submit" onclick="console.log('SUBMIT CLICKED')">Post</button>
            </form>
        </div>

        <div class="box">
            <ul>
                <li th:each="post : ${posts}" class="mb-3">
                    <p th:text="${post.content} + ' – Posted at ' + ${#temporals.format(post.timestamp, 'yyyy-MM-dd HH:mm:ss', userTimezone)}"></p>
                    <div th:if="${post.mediaUrl != null}">

                        <img th:if="${post.mediaType == 'image'}"
                             th:src="${post.mediaUrl}"
                             alt="Post image"
                             style="width: 50%; height: auto; object-fit: cover;">

                        <video th:if="${post.mediaType == 'video'}"
                               th:src="${post.mediaUrl}"
                               controls
                               style="width: 100%; height: auto; object-fit: cover;">
                        </video>

                        <audio th:if="${post.mediaType == 'audio'}"
                               th:src="${post.mediaUrl}"
                               controls>
                        </audio>

                    </div>
                </li>
            </ul>
        </div>


    </main>

    <div th:replace="~{fragments/action-dialogue :: dialog(
      title='Admins',
      id='adminPanel',
      cta_link='/artists/new',
      cta='Add new admin',
      content=(~{::adminList})
    )}">
        <div th:fragment="adminList">
            <ul style="display: flex; margin: 12px 0;">
                <li th:each="admin : ${admins}">
                    <div th:replace="~{fragments/display-card :: displayCard(${admin.user.name}, '/users/' + ${admin.user.id}, 'https://placehold.co/128', 'Picture of admin')}"></div>
                </li>
            </ul>
        </div>
    </div>

    <!-- right column
     fan wall could be carousel of images/videos of fans, maybe they tag artist and they show up here.-->
    <aside class="right-column">

        <div class="box">
            <h3>Upcoming Dates</h3>
            <ul th:each="concert:${concerts}">
                <li th:text="${#temporals.format(concert.concertDate, 'dd MMM yyyy')} + ' - ' + ${concert.venue.city} + ', ' + ${concert.venue.country}"></li>
            </ul>
            <button>View all dates</button>
        </div>

    </aside>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("new-post-form");
            const mediaInput = document.getElementById("media_file");
            const clearBtn = document.getElementById("clearMediaBtn");

            const uploadWrapper = document.getElementById("uploadWrapper");
            const bar = document.getElementById("uploadProgressBar");
            const status = document.getElementById("uploadStatus");

            const mediaUrlHidden = document.getElementById("mediaUrl");
            const mediaTypeHidden = document.getElementById("mediaType");
            const submitBtn = document.getElementById("post-submit");

            clearBtn.classList.add("d-none");

            mediaInput.addEventListener("change", function () {
                if (mediaInput.files && mediaInput.files.length > 0) {
                    clearBtn.classList.remove("d-none");
                } else {
                    clearBtn.classList.add("d-none");
                }
            });

            clearBtn.addEventListener("click", function () {
                mediaInput.value = "";
                clearBtn.classList.add("d-none");
            });

            function showProgress() {
                uploadWrapper.classList.remove("d-none");
                bar.style.width = "0%";
                bar.textContent = "0%";
                status.textContent = "Uploading…";
            }

            function hideProgress() {
                uploadWrapper.classList.add("d-none");
                bar.style.width = "0%";
                bar.textContent = "";
                status.textContent = "";
            }

            hideProgress();

            if (clearBtn && mediaInput) {
                clearBtn.addEventListener("click", function () {
                    mediaInput.value = "";
                    clearBtn.classList.add("d-none");
                    hideProgress();
                });
            }

            if (mediaInput) {
                mediaInput.addEventListener("change", function () {
                    if (mediaInput.files && mediaInput.files.length > 0) {
                        clearBtn.classList.remove("d-none");
                    } else {
                        clearBtn.classList.add("d-none");
                        hideProgress();
                    }
                });
            }

            form.addEventListener("submit", async function (e) {
                const file = mediaInput.files && mediaInput.files[0];

                if (!file) {
                    hideProgress();
                    return;
                }

                e.preventDefault();
                submitBtn.disabled = true;
                showProgress();

                const fileType = (file.type || "").toLowerCase();
                let inferredMediaType = "image";
                if (fileType.startsWith("audio/")) inferredMediaType = "audio";
                else if (fileType.startsWith("video/")) inferredMediaType = "video";

                try {
                    const sigRes = await fetch("/cloudinary/signature");
                    const sig = await sigRes.json();

                    const fd = new FormData();
                    fd.append("file", file);
                    fd.append("api_key", sig.apiKey);
                    fd.append("timestamp", sig.timestamp);
                    fd.append("signature", sig.signature);
                    fd.append("folder", sig.folder);

                    const uploadUrl =
                        `https://api.cloudinary.com/v1_1/${sig.cloudName}/auto/upload`;

                    const uploaded = await new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        xhr.open("POST", uploadUrl);

                        xhr.upload.onprogress = function (evt) {
                            if (evt.lengthComputable) {
                                const pct = Math.round((evt.loaded / evt.total) * 100);
                                bar.style.width = pct + "%";
                                bar.textContent = pct + "%";
                            }
                        };

                        xhr.onload = function () {
                            if (xhr.status >= 200 && xhr.status < 300) {
                                resolve(JSON.parse(xhr.responseText));
                            } else {
                                reject(new Error("Upload failed"));
                            }
                        };

                        xhr.onerror = () => reject(new Error("Network error"));
                        xhr.send(fd);
                    });

                    mediaUrlHidden.value = uploaded.secure_url;
                    mediaTypeHidden.value = inferredMediaType;

                    mediaInput.disabled = true;

                    hideProgress();

                    form.submit();

                } catch (err) {
                    console.error(err);
                    status.textContent = "Upload failed. Please try again.";
                    submitBtn.disabled = false;
                }   
            });
        });
    </script>



</div>

</body>
</html>
